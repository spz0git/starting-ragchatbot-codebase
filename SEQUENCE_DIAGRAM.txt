═══════════════════════════════════════════════════════════════════════════════════════════
                        SEQUENCE DIAGRAM - QUERY PROCESSING
═══════════════════════════════════════════════════════════════════════════════════════════

Timeline of interactions from user query to response display:


┌─────────┐      ┌─────────┐      ┌─────────┐      ┌─────────┐      ┌──────────┐
│ Browser │      │ FastAPI │      │RAGSystem│      │ Claude  │      │ ChromaDB │
│ (FE)    │      │(Backend)│      │  (BE)   │      │  (API)  │      │(VectorDB)│
└────┬────┘      └────┬────┘      └────┬────┘      └────┬────┘      └────┬─────┘
     │                │                │                │                │
     │  "What is MCP?"│                │                │                │
     │─ POST /api/query──────────────>│                │                │
     │                │                │                │                │
     │                │ Create session │                │                │
     │                │ (if needed)    │                │                │
     │                │  "session_1"   │                │                │
     │                │                │                │                │
     │                │  Call rag.query()              │                │
     │                ├──────────────>│                │                │
     │                │                │                │                │
     │                │                │ Get conversation│               │
     │                │                │ history (if any)│               │
     │                │                │                │                │
     │                │                │ build_prompt() │                │
     │                │                │ + tools def    │                │
     │                │                │                │                │
     │                │                │ Call generate_response()        │
     │                │                ├─────────────>│                │
     │                │                │                │                │
     │                │                │                │ Claude analyzes│
     │                │                │                │ "This is a     │
     │                │                │                │  course Q"     │
     │                │                │                │                │
     │                │                │                │ Decides: use   │
     │                │                │                │ search tool    │
     │                │                │                │                │
     │                │                │                │ Responds:      │
     │                │                │                │ tool_use       │
     │                │                │  {tool_use}   │                │
     │                │                │<─────────────│                │
     │                │                │                │                │
     │                │                │ Execute tool   │                │
     │                │                │ (search)       │                │
     │                │                │                │                │
     │                │                │ Call VectorStore.search()       │
     │                │                ├────────────────────────────────>│
     │                │                │                │                │
     │                │                │                │  Query with    │
     │                │                │                │  embeddings    │
     │                │                │                │                │
     │                │                │                │  Find similar  │
     │                │                │                │  content (cosine)
     │                │                │                │                │
     │                │                │  Top 5 results │                │
     │                │                │  + metadata    │                │
     │                │                │<────────────────────────────────│
     │                │                │                │                │
     │                │                │ Format results │                │
     │                │                │ [Intro-L1]...  │                │
     │                │                │ [Intro-L2]...  │                │
     │                │                │                │                │
     │                │                │ Send tool      │                │
     │                │                │ results to     │                │
     │                │                │ Claude         │                │
     │                │                │ + original Q   │                │
     │                │                │                │                │
     │                │                │                │ Claude reads   │
     │                │                │                │ search results │
     │                │                │                │                │
     │                │                │                │ Generates      │
     │                │                │                │ answer based   │
     │                │                │                │ on results     │
     │                │                │                │                │
     │                │                │ Final answer   │                │
     │                │                │<─────────────│                │
     │                │                │                │                │
     │                │                │ Get sources    │                │
     │                │                │ from tool_mgr  │                │
     │                │                │                │                │
     │                │                │ Update session │                │
     │                │                │ (user Q +      │                │
     │                │                │  assistant A)  │                │
     │                │                │                │                │
     │                │ Return answer  │                │                │
     │                │ + sources      │                │                │
     │                │<──────────────│                │                │
     │                │                │                │                │
     │  QueryResponse │                │                │                │
     │<──────────────│                │                │                │
     │                │                │                │                │
     │ Parse JSON    │                │                │                │
     │ Update DOM    │                │                │                │
     │ Show answer   │                │                │                │
     │ + sources     │                │                │                │
     │                │                │                │                │
     ✓ Complete     ✓                 ✓                ✓               ✓


═══════════════════════════════════════════════════════════════════════════════════════════
                            INTERACTION DETAILS BY PHASE
═══════════════════════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│ PHASE 1: REQUEST TRANSMISSION (Browser → FastAPI)                                      │
└─────────────────────────────────────────────────────────────────────────────────────────┘

Browser                                          FastAPI
  │                                               │
  │ fetch("POST /api/query", {                  │
  │   "query": "What is MCP?",                  │
  │   "session_id": null                        │
  │ })                                          │
  ├─────────────────────────────────────────────>
  │                                               │
  │                                    Receive request
  │                                    Create QueryRequest
  │                                    session_id = null
  │                                               │
  │                                    Generate new session
  │                                    session_id = "session_1"
  │                                               │


┌─────────────────────────────────────────────────────────────────────────────────────────┐
│ PHASE 2: RAG PROCESSING (FastAPI → RAG System)                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘

FastAPI                                         RAG System
  │                                               │
  │ rag_system.query(                           │
  │   query="What is MCP?",                    │
  │   session_id="session_1"                   │
  │ )                                          │
  ├─────────────────────────────────────────────>
  │                                               │
  │                                    • Get conversation history
  │                                      (none for first query)
  │                                               │
  │                                    • Prepare prompt
  │                                      "Answer about: What is MCP?"
  │                                               │
  │                                    • Gather tool definitions
  │                                      (search_course_content tool)
  │                                               │
  │                                    Call: ai_generator.generate_response()
  │                                               │


┌─────────────────────────────────────────────────────────────────────────────────────────┐
│ PHASE 3: AI DECISION MAKING (RAG → Claude API)                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘

RAG System                                      Claude API
  │                                               │
  │ generate_response(                          │
  │   query="Answer about: What is MCP?",      │
  │   tools=[search_tool_def],                 │
  │   temperature=0,                           │
  │   max_tokens=800                           │
  │ )                                          │
  ├─────────────────────────────────────────────>
  │                                               │
  │                                    ⏳ ~500ms processing
  │
  │                                    Claude determines:
  │                                    1. Type: Course-specific question
  │                                    2. Action: Use search tool
  │                                    3. Search params:
  │                                       - query: "MCP model context"
  │                                       - course_name: null
  │                                       - lesson_number: null
  │                                               │
  │   {                                         │
  │     "stop_reason": "tool_use",             │
  │     "content": [                           │
  │       {                                    │
  │         "type": "tool_use",                │
  │         "name": "search_course_content",   │
  │         "input": {                         │
  │           "query": "MCP model context"    │
  │         }                                  │
  │       }                                    │
  │     ]                                      │
  │   }                                        │
  │<─────────────────────────────────────────
  │                                               │


┌─────────────────────────────────────────────────────────────────────────────────────────┐
│ PHASE 4: TOOL EXECUTION (AI Generator → Vector Store)                                  │
└─────────────────────────────────────────────────────────────────────────────────────────┘

AI Generator                                    Vector Store
  │                                               │
  │ tool_manager.execute_tool(                  │
  │   "search_course_content",                 │
  │   query="MCP model context"                │
  │ )                                          │
  ├─────────────────────────────────────────────>
  │                                               │
  │                                    CourseSearchTool.execute()
  │                                    Call: store.search()
  │                                               │
  │ store.search(                              │
  │   query="MCP model context",              │
  │   course_name=None,                       │
  │   lesson_number=None                      │
  │ )                                          │
  ├─────────────────────────────────────────────>
  │                                               │
  │                                    ⏳ ~200ms embedding + search
  │
  │                                    1. Encode query → vector
  │                                    2. Find top 5 similar
  │                                    3. Gather metadata
  │                                               │
  │   SearchResults(                           │
  │     documents=[                            │
  │       "MCP stands for Model...",          │
  │       "The protocol enables...",          │
  │       ...                                 │
  │     ],                                    │
  │     metadata=[                            │
  │       {course_title: "Intro to MCP",     │
  │        lesson_number: 1},                │
  │       ...                                │
  │     ]                                    │
  │   )                                       │
  │<─────────────────────────────────────────
  │                                               │
  │ Format results                              │
  │ Store sources for UI                       │
  │ Return formatted string                   │
  │                                               │


┌─────────────────────────────────────────────────────────────────────────────────────────┐
│ PHASE 5: FINAL RESPONSE GENERATION (AI Generator → Claude API)                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘

AI Generator                                    Claude API
  │                                               │
  │ messages.append({                          │
  │   "role": "assistant",                    │
  │   "content": [tool_use_response]          │
  │ })                                        │
  │                                               │
  │ messages.append({                          │
  │   "role": "user",                         │
  │   "content": [tool_results]               │
  │ })                                        │
  │                                               │
  │ Create new message (no tools)              │
  │ system = same_prompt                      │
  │ messages = updated_messages                │
  │                                               │
  │ client.messages.create(...)                │
  ├─────────────────────────────────────────────>
  │                                               │
  │                                    ⏳ ~1000ms final generation
  │
  │                                    Claude reads:
  │                                    • Original question
  │                                    • Search results with context
  │                                    • System prompt
  │                                               │
  │                                    Generates:
  │                                    "MCP (Model Context Protocol)
  │                                     is a standardized protocol
  │                                     that enables AI assistants..."
  │                                               │
  │   {                                        │
  │     "content": [                          │
  │       {                                   │
  │         "type": "text",                   │
  │         "text": "MCP (Model..."          │
  │       }                                   │
  │     ]                                     │
  │   }                                       │
  │<─────────────────────────────────────────
  │                                               │
  │ Extract text from response                │
  │ Return to RAG system                      │
  │                                               │


┌─────────────────────────────────────────────────────────────────────────────────────────┐
│ PHASE 6: SESSION UPDATE & RESPONSE (RAG → FastAPI → Browser)                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘

RAG System                 FastAPI                Browser
  │                          │                       │
  │ response = "MCP is..."   │                       │
  │ sources = [...]          │                       │
  │                          │                       │
  │ Update session history   │                       │
  │ {                        │                       │
  │   session_1: [          │                       │
  │     {role: "user",      │                       │
  │      content: "What..."},│                       │
  │     {role: "assistant", │                       │
  │      content: "MCP..."}  │                       │
  │   ]                      │                       │
  │ }                        │                       │
  │                          │                       │
  │ return (response, sources)                       │
  ├─────────────────────────>                       │
  │                          │                       │
  │                          │ QueryResponse {      │
  │                          │   answer: "MCP...",  │
  │                          │   sources: [...],    │
  │                          │   session_id: "s_1"  │
  │                          │ }                    │
  │                          │                       │
  │                          │ JSON response        │
  │                          ├───────────────────────>
  │                          │                       │
  │                          │                       │ Parse JSON
  │                          │                       │ Update UI:
  │                          │                       │ • Remove loading
  │                          │                       │ • Add assistant msg
  │                          │                       │ • Render markdown
  │                          │                       │ • Add sources box
  │                          │                       │ • Store session_id
  │                          │                       │
  │                          │                       ✓ Done


═══════════════════════════════════════════════════════════════════════════════════════════
                            DATA STRUCTURE FLOW
═══════════════════════════════════════════════════════════════════════════════════════════

INPUT:
  QueryRequest {
    query: string          # User's question
    session_id: string     # Session ID (null for first query)
  }

↓ RAG PIPELINE ↓

VECTOR SEARCH RESULTS:
  SearchResults {
    documents: [           # Content chunks
      "MCP stands for...",
      "The protocol..."
    ],
    metadata: [            # Context for each chunk
      {
        course_title: "Introduction to MCP",
        lesson_number: 1,
        chunk_index: 0
      },
      ...
    ],
    distances: [0.23, 0.45, ...] # Similarity scores
  }

↓ TOOL FORMATTING ↓

FORMATTED TOOL RESULT:
  "[Introduction to MCP - Lesson 1]\n"
  "MCP stands for Model Context Protocol...\n"
  "\n"
  "[Introduction to MCP - Lesson 2]\n"
  "The protocol enables..."

↓ CLAUDE PROCESSING ↓

FINAL OUTPUT:
  QueryResponse {
    answer: string,        # Markdown-formatted answer
    sources: [             # Source citations for UI
      "Introduction to MCP - Lesson 1",
      "Introduction to MCP - Lesson 2"
    ],
    session_id: string     # For maintaining conversation
  }

↓ FRONTEND RENDERING ↓

DISPLAYED TO USER:
  User: "What is MCP?"

  Assistant: "MCP (Model Context Protocol) is a
  standardized protocol that enables AI assistants
  to interact with tools and resources..."

  ▼ Sources
    • Introduction to MCP - Lesson 1
    • Introduction to MCP - Lesson 2


═══════════════════════════════════════════════════════════════════════════════════════════
